/****************************************************************************/
/*                                                                          */
/*    新核科技(广州)有限公司                                                */
/*                                                                          */
/*    Copyright (C) 2022 CoreKernel Technology (Guangzhou) Co., Ltd         */
/*                                                                          */
/****************************************************************************/
/****************************************************************************/
/*                                                                          */
/*    温湿度传感器                                                          */
/*                                                                          */
/*    2022年03月17日                                                        */
/*                                                                          */
/****************************************************************************/
/*
 *    - 希望缄默(bin wang)
 *    - bin@corekernel.net
 *
 *    官网 corekernel.net/.org/.cn
 *    社区 fpga.net.cn
 *
 */
#include <App.h>

/****************************************************************************/
/*                                                                          */
/*              宏定义                                                      */
/*                                                                          */
/****************************************************************************/
/// SHT30 地址
#define ADDRESS   0x44

/****************************************************************************/
/*                                                                          */
/*              全局变量                                                    */
/*                                                                          */
/****************************************************************************/
extern unsigned char I2CData[10];

/****************************************************************************/
/*                                                                          */
/*              函数声明                                                    */
/*                                                                          */
/****************************************************************************/
extern void I2CRcvBlocking(unsigned int baseAddr, unsigned int dataCnt);
void I2CSendBlocking(unsigned int baseAddr, unsigned int dataCnt);

/****************************************************************************/
/*                                                                          */
/*              CRC 校验                                                    */
/*                                                                          */
/****************************************************************************/
// CRC8 多项式为 x^8 + x^5 + x^4 + 1
// 校验码为 0x31

uint8_t CRC8(const unsigned char *data, int len)
{
     unsigned char crc = 0xFF;

     int i, j;
     for(i = 0; i < len; i++)
     {
        crc ^= *data++;

        for(j = 0; j < 8; j++)
        {
            crc = (crc & 0x80) ? (crc << 1) ^ 0x31 : (crc << 1);
        }
     }

     return crc;
}

/****************************************************************************/
/*                                                                          */
/*              获取温湿度值                                                */
/*                                                                          */
/****************************************************************************/
void TempSensorGet(float *t, float *rh)
{
    // 设置从设备地址
    I2CMasterSlaveAddrSet(SOC_I2C_0_REGS, ADDRESS);

    // 读取数据
    I2CRcvBlocking(SOC_I2C_0_REGS, 6);

    // 换算
    unsigned short val;

    // 温度
    val = (I2CData[0] << 8) | I2CData[1];
    *t = -45 + 175 * (val * 1.0 / 65535);

    // 湿度
    val = (I2CData[3] << 8) | I2CData[4];
    *rh = 100 * (val * 1.0 / 65535);
}

/****************************************************************************/
/*                                                                          */
/*              初始化                                                      */
/*                                                                          */
/****************************************************************************/
void TempSensorInit()
{
    // I2C 配置
    I2CInit(SOC_I2C_0_REGS, ADDRESS);

    // 周期模式（1秒）
    I2CData[0] = 0x21;
    I2CData[1] = 0x30;
    I2CSendBlocking(SOC_I2C_0_REGS, 2);
}
